<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conversation Dashboard - Ollama Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #2c3e50;
      color: white;
      border-bottom: 1px solid #34495e;
    }

    #logo {
      font-size: 20px;
      font-weight: bold;
    }

    .nav-link {
      color: #3498db;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 5px;
      background: rgba(52, 152, 219, 0.1);
    }

    .nav-link:hover {
      background: rgba(52, 152, 219, 0.2);
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .search-box {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      width: 300px;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 5px;
      font-size: 14px;
    }

    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-secondary { background: #6c757d; color: white; }

    .conversations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .conversation-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }

    .conversation-card.selected {
      border-color: #007bff;
      box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .conversation-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 5px;
      cursor: pointer;
    }

    .conversation-title:hover {
      color: #007bff;
    }

    .conversation-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    .conversation-preview {
      font-size: 14px;
      color: #555;
      line-height: 1.4;
      margin-bottom: 15px;
      max-height: 60px;
      overflow: hidden;
    }

    .card-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .card-actions .btn {
      padding: 5px 10px;
      font-size: 12px;
    }

    .bulk-actions {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }

    .bulk-actions.show {
      display: block;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      flex: 1;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .checkbox {
      margin-right: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h3 {
      margin-bottom: 10px;
    }

    .category-section {
      margin-bottom: 30px;
    }

    .category-header {
      background: #e9ecef;
      padding: 12px 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      font-weight: bold;
      color: #495057;
      border-left: 4px solid #007bff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .category-header:hover {
      background: #dee2e6;
    }

    .category-stats {
      font-size: 12px;
      color: #666;
      font-weight: normal;
    }

    .category-toggle {
      font-size: 14px;
      margin-left: 10px;
      transition: transform 0.2s;
    }

    .category-content {
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      overflow: hidden;
    }

    .category-content.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div id="header">
    <div id="logo">ü¶ô Conversation Dashboard</div>
    <a href="/" class="nav-link">‚Üê Back to Chat</a>
  </div>

  <div class="container">
    <div class="dashboard-header">
      <h2>Saved Conversations</h2>
      <div>
        <input type="text" id="search-box" class="search-box" placeholder="Search conversations...">
        <button class="btn btn-primary" onclick="refreshConversations()">üîÑ Refresh</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-conversations">0</div>
        <div class="stat-label">Total Conversations</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-messages">0</div>
        <div class="stat-label">Total Messages</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="selected-count">0</div>
        <div class="stat-label">Selected</div>
      </div>
    </div>

    <div class="bulk-actions" id="bulk-actions">
      <strong>Bulk Actions:</strong>
      <button class="btn btn-success" onclick="exportSelected()">üì§ Export Selected</button>
      <button class="btn btn-danger" onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
      <button class="btn btn-secondary" onclick="clearSelection()">‚úï Clear Selection</button>
    </div>

    <div id="conversations-container">
      <div class="empty-state">
        <h3>Loading conversations...</h3>
      </div>
    </div>
  </div>

  <script>
    let conversations = [];
    let selectedConversations = new Set();
    let collapsedCategories = new Set();

    // Storage functions
    function loadFromStorage(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (error) {
        console.error('Failed to load from localStorage:', error);
        return null;
      }
    }

    function saveToStorage(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (error) {
        console.error('Failed to save to localStorage:', error);
      }
    }

    function loadConversations() {
      conversations = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('ollama-chat-saved-')) {
          const data = loadFromStorage(key);
          if (data) {
            conversations.push({ key, ...data });
          }
        }
      }
      conversations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    function renderConversations(filteredConversations = conversations) {
      const container = document.getElementById('conversations-container');
      
      if (filteredConversations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No conversations found</h3>
            <p>Start chatting to create your first conversation!</p>
          </div>
        `;
        return;
      }

      // Group by category
      const grouped = {};
      filteredConversations.forEach(conv => {
        const category = conv.category || 'General';
        if (!grouped[category]) grouped[category] = [];
        grouped[category].push(conv);
      });

      let html = '';
      Object.keys(grouped).sort().forEach(category => {
        const categoryConvs = grouped[category];
        const totalMessages = categoryConvs.reduce((sum, conv) => sum + (conv.messages || []).length, 0);
        
        const isCollapsed = collapsedCategories.has(category);
        html += `
          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('${category}')">
              <span>üìÅ ${category}<span class="category-toggle">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span></span>
              <span class="category-stats">${categoryConvs.length} conversations ‚Ä¢ ${totalMessages} messages</span>
            </div>
            <div class="category-content ${isCollapsed ? 'collapsed' : ''}">
              <div class="conversations-grid">
        `;
        
        categoryConvs.forEach(conv => {
          const messageCount = (conv.messages || []).length;
          const preview = getConversationPreview(conv.messages || []);
          const isSelected = selectedConversations.has(conv.key);
          
          html += `
            <div class="conversation-card ${isSelected ? 'selected' : ''}" data-key="${conv.key}">
              <div class="card-header">
                <div>
                  <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} 
                         onchange="toggleSelection('${conv.key}')">
                  <span class="conversation-title" onclick="openConversation('${conv.key}')">${conv.name}</span>
                </div>
              </div>
              <div class="conversation-meta">
                üìÖ ${new Date(conv.createdAt).toLocaleString()} ‚Ä¢ 
                ü§ñ ${conv.selectedModel || 'Unknown'} ‚Ä¢ 
                üí¨ ${messageCount} messages
              </div>
              <div class="conversation-preview">${preview}</div>
              <div class="card-actions">
                <button class="btn btn-primary" onclick="openConversation('${conv.key}')">üìñ Open</button>
                <button class="btn btn-secondary" onclick="renameConversation('${conv.key}')">‚úèÔ∏è Rename</button>
                <button class="btn btn-success" onclick="exportConversation('${conv.key}')">üì§ Export</button>
                <button class="btn btn-danger" onclick="deleteConversation('${conv.key}')">üóëÔ∏è Delete</button>
              </div>
            </div>
          `;
        });
        
        html += `
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateStats();
    }

    function getConversationPreview(messages) {
      if (!messages || messages.length === 0) return 'No messages';
      
      const firstUserMessage = messages.find(m => m.sender === 'user');
      if (firstUserMessage) {
        return firstUserMessage.text.substring(0, 100) + (firstUserMessage.text.length > 100 ? '...' : '');
      }
      
      return 'No user messages';
    }

    function updateStats() {
      const totalMessages = conversations.reduce((sum, conv) => sum + (conv.messages || []).length, 0);
      
      document.getElementById('total-conversations').textContent = conversations.length;
      document.getElementById('total-messages').textContent = totalMessages;
      document.getElementById('selected-count').textContent = selectedConversations.size;
      
      const bulkActions = document.getElementById('bulk-actions');
      if (selectedConversations.size > 0) {
        bulkActions.classList.add('show');
      } else {
        bulkActions.classList.remove('show');
      }
    }

    function toggleSelection(key) {
      if (selectedConversations.has(key)) {
        selectedConversations.delete(key);
      } else {
        selectedConversations.add(key);
      }
      renderConversations();
    }

    function clearSelection() {
      selectedConversations.clear();
      renderConversations();
    }

    function openConversation(key) {
      window.location.href = `/?load=${key}`;
    }

    function renameConversation(key) {
      const conv = conversations.find(c => c.key === key);
      if (!conv) return;
      
      const newName = prompt('Enter new name:', conv.name);
      if (newName && newName.trim()) {
        conv.name = newName.trim();
        saveToStorage(key, conv);
        refreshConversations();
      }
    }

    async function deleteConversation(key) {
      const conv = conversations.find(c => c.key === key);
      if (!conv) return;
      
      if (confirm(`Delete "${conv.name}"?`)) {
        // Check for images in conversation
        const imageUrls = [];
        if (conv.messages) {
          conv.messages.forEach(msg => {
            if (msg.imageData && msg.imageData.fullUrl) {
              imageUrls.push(msg.imageData.fullUrl);
            }
          });
        }
        
        // Delete images from server if any exist
        if (imageUrls.length > 0) {
          try {
            await fetch('/api/conversation-images', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ imageUrls })
            });
            console.log(`Deleted ${imageUrls.length} images for conversation`);
          } catch (error) {
            console.error('Failed to delete images:', error);
          }
        }
        
        localStorage.removeItem(key);
        selectedConversations.delete(key);
        refreshConversations();
      }
    }

    function exportConversation(key) {
      const conv = conversations.find(c => c.key === key);
      if (!conv) return;
      
      const blob = new Blob([JSON.stringify(conv, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${conv.name.replace(/[^a-z0-9]/gi, '_')}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportSelected() {
      if (selectedConversations.size === 0) return;
      
      const selectedData = conversations.filter(c => selectedConversations.has(c.key));
      const exportData = {
        exportedAt: new Date().toISOString(),
        conversations: selectedData
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ollama-conversations-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function deleteSelected() {
      if (selectedConversations.size === 0) return;
      
      if (confirm(`Delete ${selectedConversations.size} selected conversations?`)) {
        // Collect all image URLs from selected conversations
        const allImageUrls = [];
        selectedConversations.forEach(key => {
          const conv = conversations.find(c => c.key === key);
          if (conv && conv.messages) {
            conv.messages.forEach(msg => {
              if (msg.imageData && msg.imageData.fullUrl) {
                allImageUrls.push(msg.imageData.fullUrl);
              }
            });
          }
        });
        
        // Delete images from server if any exist
        if (allImageUrls.length > 0) {
          try {
            await fetch('/api/conversation-images', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ imageUrls: allImageUrls })
            });
            console.log(`Deleted ${allImageUrls.length} images from selected conversations`);
          } catch (error) {
            console.error('Failed to delete images:', error);
          }
        }
        
        selectedConversations.forEach(key => {
          localStorage.removeItem(key);
        });
        selectedConversations.clear();
        refreshConversations();
      }
    }

    function refreshConversations() {
      loadConversations();
      renderConversations();
    }

    // Search functionality
    document.getElementById('search-box').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      if (!query) {
        renderConversations();
        return;
      }
      
      const filtered = conversations.filter(conv => 
        conv.name.toLowerCase().includes(query) ||
        (conv.messages || []).some(msg => 
          msg.text.toLowerCase().includes(query)
        )
      );
      
      renderConversations(filtered);
    });

    function toggleCategory(category) {
      if (collapsedCategories.has(category)) {
        collapsedCategories.delete(category);
      } else {
        collapsedCategories.add(category);
      }
      renderConversations();
    }

    // Initialize
    refreshConversations();
  </script>
</body>
</html>